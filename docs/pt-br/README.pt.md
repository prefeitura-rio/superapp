# üèõÔ∏è SuperApp - PrefRio üáßüá∑

## Sum√°rio

- [Vis√£o Geral](#vis√£o-geral)
- [Pr√©-requisitos](#pr√©-requisitos)
- [Instala√ß√£o e Configura√ß√£o](#instala√ß√£o-e-configura√ß√£o)
- [Como Rodar o Projeto](#como-rodar-o-projeto)
- [Sistema de Autentica√ß√£o](#sistema-de-autentica√ß√£o)
- [Orval - Gera√ß√£o de API](#orval---gera√ß√£o-de-api)
- [Estrutura do Projeto](#estrutura-do-projeto)
- [Scripts Dispon√≠veis](#scripts-dispon√≠veis)

## Vis√£o Geral

Este √© um projeto **Next.js 15** constru√≠do com:

- **Framework**: Next.js 15.4.6 com React 19
- **Linguagem**: TypeScript
- **Estiliza√ß√£o**: Tailwind CSS 4.1.5
- **Autentica√ß√£o**: Keycloak (Identidade Carioca)
- **Gera√ß√£o de Http Clients API**: Orval
- **UI Components**: Radix UI + shadcn/ui
- **Valida√ß√£o**: Zod + React Hook Form
- **Node Version**: 23.7.0

## Pr√©-requisitos

Antes de come√ßar, certifique-se de ter instalado:

- **Node.js**: vers√£o 23.7.0 (recomendado usar nvm)
- **npm**: vers√£o compat√≠vel com Node 23.7.0
- **Git**: para versionamento

### Instalando o Node.js correto

```bash
# Se voc√™ usa nvm (recomendado)
nvm install 23.7.0
nvm use 23.7.0

# Verifique a vers√£o instalada
node --version
```

## Instala√ß√£o e Configura√ß√£o

### 1. Clone o reposit√≥rio

```bash
git clone git@github.com:prefeitura-rio/superapp.git
cd superapp
```

### 2. Instale as depend√™ncias

```bash
npm install
```

### 3. Configure as vari√°veis de ambiente

Crie um arquivo `.env` na raiz do projeto com as seguintes vari√°veis e seus respectivos valores:

```env
# Keycloak / Identidade Carioca
NEXT_PUBLIC_IDENTIDADE_CARIOCA_BASE_URL=
NEXT_PUBLIC_IDENTIDADE_CARIOCA_CLIENT_ID=superapp
NEXT_PUBLIC_IDENTIDADE_CARIOCA_REDIRECT_URI=
IDENTIDADE_CARIOCA_CLIENT_SECRET=

# URLs das APIs
NEXT_PUBLIC_BASE_API_URL=
NEXT_PUBLIC_BASE_API_URL_APP_BUSCA_SEARCH=
NEXT_PUBLIC_BASE_API_URL_SUBPAV_OSA_API=
NEXT_PUBLIC_BASE_API_URL_RMI=
NEXT_PUBLIC_COURSES_BASE_API_URL=

# Gov.br
NEXT_PUBLIC_GOVBR_BASE_URL=

# Analytics e Tracking
NEXT_PUBLIC_HOTJAR_ID=
NEXT_PUBLIC_GOOGLE_ANALYTICS_ID=
NEXT_PUBLIC_GOOGLE_TAG_MANAGER_ID=G

# Google Maps
GOOGLE_MAPS_API_KEY=

# reCAPTCHA
NEXT_PUBLIC_RECAPTCHA_SITE_KEY=

# API Keys Internas
API_KEY_SUBPAV_OSA_SMS=

# Ambiente
NODE_ENV=development
```

## Como Rodar o Projeto

### Modo Desenvolvimento

Para iniciar o servidor de desenvolvimento com Turbopack:

```bash
npm run dev
```

O aplicativo estar√° dispon√≠vel em [http://localhost:3000](http://localhost:3000)

### Modo Produ√ß√£o

Para fazer build e rodar em modo produ√ß√£o:

```bash
# Build da aplica√ß√£o
npm run build

# Iniciar servidor de produ√ß√£o
npm start
```

### Lint

Para executar verifica√ß√µes de c√≥digo:

```bash
npm run lint
```

## Sistema de Autentica√ß√£o

A aplica√ß√£o utiliza **Keycloak** (Identidade Carioca) para autentica√ß√£o via OAuth 2.0 / OpenID Connect.

### Fluxo de Autentica√ß√£o

#### 1. **In√≠cio do Login**

O usu√°rio √© redirecionado para o Keycloak (Identidade Carioca) quando tenta acessar rotas protegidas:

#### 2. **Callback ap√≥s Login**

Ap√≥s autentica√ß√£o bem-sucedida, o Keycloak redireciona para:

```
/api/auth/callback/keycloak
```

**O que acontece:**

- Recebe o `code` do authorization code flow
- Troca o `code` por tokens (access_token e refresh_token) no endpoint `/token` do Keycloak
- Armazena os tokens em cookies httpOnly:
  - `access_token`: usado para autenticar requisi√ß√µes √† API
  - `refresh_token`: usado para renovar o access_token quando expira

#### 3. **Middleware de Prote√ß√£o de Rotas**

**Arquivo**: [`src/middleware.ts`](../../src/middleware.ts)

O middleware protege rotas e gerencia o estado de autentica√ß√£o:

**Rotas P√∫blicas:**

- `/` (home)
- `/busca/*`
- `/servicos/*`
- `/ouvidoria/*`
- `/sessao-expirada`
- `/politicas-de-uso-de-cookies`

**Rotas Protegidas:**

- `/carteira` (carteiras digitais)
- `/meu-perfil` (dados do usu√°rio)
- Qualquer rota n√£o listada como p√∫blica

**Funcionalidades do Middleware:**

1. **Verifica√ß√£o de Token**: Checa se o `access_token` existe nos cookies
2. **Valida√ß√£o de Expira√ß√£o**: Usa `isJwtExpired()` para verificar se o token JWT expirou
3. **Refresh Autom√°tico**: Se o token expirou, tenta renov√°-lo usando o `refresh_token`
4. **Redirecionamento**: Redireciona usu√°rios n√£o autenticados para rotas de login

#### 4. **Renova√ß√£o de Token**

Quando o `access_token` expira, o sistema:

- Usa o `refresh_token` para obter um novo `access_token`
- Faz uma requisi√ß√£o POST ao endpoint `/token` do Keycloak
- Atualiza os cookies com os novos tokens

#### 5. **Logout**

Processo de logout:

1. Recupera o `refresh_token` dos cookies
2. Faz uma requisi√ß√£o ao endpoint `/logout` do Keycloak
3. Limpa os cookies de autentica√ß√£o (access_token e refresh_token)

### Uso dos Tokens nas Requisi√ß√µes API

O `customFetch` automaticamente adiciona o token de autentica√ß√£o em todas as requisi√ß√µes:

### Seguran√ßa

- **Cookies httpOnly**: Tokens n√£o s√£o acess√≠veis via JavaScript (protege contra XSS)
- **CSP Headers**: Content Security Policy configurada no middleware
- **Token Expiration**: Valida√ß√£o autom√°tica de expira√ß√£o de tokens
- **Refresh Token Flow**: Renova√ß√£o de tokens sem interromper a experi√™ncia do usu√°rio

## Orval - Gera√ß√£o de Http Clients API

O **Orval** √© uma ferramenta que gera automaticamente c√≥digo TypeScript para consumir APIs REST a partir de uma especifica√ß√£o OpenAPI.

### O que √© o Orval?

Orval l√™ um arquivo OpenAPI (JSON/YAML) e gera:

- **Tipos TypeScript**: Interfaces e types baseados nos schemas da API
- **Fun√ß√µes de requisi√ß√£o**: Hooks e fun√ß√µes prontas para fazer chamadas HTTP
- **Valida√ß√£o**: Types seguros para requests e responses

### Configura√ß√£o do Orval

**Arquivo**: [`orval.config.ts`](../../orval.config.ts)

```typescript
import { defineConfig } from 'orval'

export default defineConfig({
  api: {
    input:
      'https://raw.githubusercontent.com/prefeitura-rio/app-rmi/refs/heads/staging/docs/openapi-v3.json',
    output: {
      target: './src/http/api.ts', // Arquivo principal gerado
      schemas: './src/http/models', // Pasta com tipos/models gerados
      mode: 'tags-split', // Separa endpoints por tags
      client: 'fetch', // Usa fetch API
      biome: true, // Formata com Biome
      httpClient: 'fetch',
      clean: true, // Limpa arquivos antigos antes de gerar
      override: {
        mutator: {
          path: './custom-fetch.ts', // Usa fetch customizado
          name: 'customFetch',
        },
      },
    },
  },
})
```

### Como o Orval funciona neste projeto

1. **Fonte de Dados (Input)**:

   - URL do OpenAPI spec: `https://raw.githubusercontent.com/prefeitura-rio/app-rmi/refs/heads/staging/docs/openapi-v3.json`
   - Orval faz download deste arquivo automaticamente

2. **Sa√≠da (Output)**:

   - **`src/http/api.ts`**: Arquivo principal com fun√ß√µes para fazer requisi√ß√µes
   - **`src/http/models/`**: Pasta com todos os tipos/interfaces TypeScript

3. **Mode: tags-split**:

   - Separa os endpoints em m√∫ltiplos arquivos baseado nas tags do OpenAPI
   - Organiza√ß√£o: `src/http/admin/`, `src/http/citizen/`, `src/http/avatars/`, etc.

4. **Custom Fetch Mutator**:
   - Usa o [`custom-fetch.ts`](../../custom-fetch.ts) para todas as requisi√ß√µes
   - Adiciona automaticamente:
     - Token de autentica√ß√£o (Bearer token)
     - Base URL correta
     - Headers necess√°rios
     - Tratamento de diferentes content-types (JSON, PDF, etc.)

### Como Rodar o Orval

#### Gerar/Regenerar APIs

```bash
npx orval
```

Este comando ir√°:

1. Baixar o arquivo OpenAPI da URL configurada
2. Limpar a pasta `src/http/` (exceto arquivos personalizados)
3. Gerar novos arquivos TypeScript com:
   - Types e interfaces em `src/http/models/`
   - Fun√ß√µes de API organizadas por tags em subpastas

#### Quando rodar o Orval?

Execute `npx orval` quando:

- A API backend adicionar novos endpoints
- A API backend modificar schemas existentes
- Voc√™ clonar o reposit√≥rio pela primeira vez
- Voc√™ precisar atualizar os tipos para refletir mudan√ßas na API

### Estrutura Gerada pelo Orval

```
src/http/
‚îú‚îÄ‚îÄ admin/          # Endpoints
‚îú‚îÄ‚îÄ avatars/        #
‚îú‚îÄ‚îÄ beta-groups/    #
‚îú‚îÄ‚îÄ beta-whitelist/ #
‚îú‚îÄ‚îÄ citizen/        #
‚îú‚îÄ‚îÄ config/         #
‚îú‚îÄ‚îÄ health/         #
‚îú‚îÄ‚îÄ metrics/        #
‚îú‚îÄ‚îÄ phone/          #
‚îú‚îÄ‚îÄ validation/     #
‚îî‚îÄ‚îÄ models/         # Todos os tipos TypeScript (schemas)
```

√â importante **n√£o modificar** os arquivos gerados autom√°ticamente.

### Exemplo de Uso

Depois que o Orval gera os arquivos, voc√™ pode importar e usar as fun√ß√µes:

```typescript
import { getCitizenProfile } from '@/http/citizen'

// A fun√ß√£o j√° tem:
// - Types corretos de request/response
// - Autentica√ß√£o autom√°tica (via custom-fetch)
// - Base URL configurada
const profile = await getCitizenProfile()
```

### Custom Fetch

O [`custom-fetch.ts`](../../custom-fetch.ts) intercepta todas as requisi√ß√µes geradas pelo Orval e:

### Benef√≠cios do Orval

‚úÖ **Type Safety**: Tipos TypeScript autom√°ticos garantem seguran√ßa em tempo de compila√ß√£o
‚úÖ **Sincroniza√ß√£o**: C√≥digo sempre sincronizado com a especifica√ß√£o da API
‚úÖ **Produtividade**: N√£o √© necess√°rio escrever manualmente tipos e fun√ß√µes de API
‚úÖ **Manutenibilidade**: Mudan√ßas na API s√£o refletidas facilmente rodando um comando
‚úÖ **DX (Developer Experience)**: Autocomplete e valida√ß√£o no editor

## Estrutura do Projeto

```
superapp/
‚îú‚îÄ‚îÄ .github/              # Workflows e configura√ß√µes do GitHub
‚îú‚îÄ‚îÄ .next/                # Build do Next.js (gerado)
‚îú‚îÄ‚îÄ docs/                 # Documenta√ß√£o adicional
‚îú‚îÄ‚îÄ k8s/                  # Configura√ß√µes Kubernetes
‚îú‚îÄ‚îÄ node_modules/         # Depend√™ncias (gerado)
‚îú‚îÄ‚îÄ public/               # Assets est√°ticos
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ actions/          # Server actions do Next.js
‚îÇ   ‚îú‚îÄ‚îÄ app/              # App Router do Next.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ (app)/        # Grupo de rotas da aplica√ß√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ (private)/    # Rotas privadas/autenticadas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/          # API routes
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth/     # Endpoints de autentica√ß√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/   # Componentes espec√≠ficos de p√°ginas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ globals.css   # Estilos globais
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ layout.tsx    # Layout raiz
‚îÇ   ‚îú‚îÄ‚îÄ assets/           # Imagens e assets
‚îÇ   ‚îú‚îÄ‚îÄ components/       # Componentes React reutiliz√°veis
‚îÇ   ‚îú‚îÄ‚îÄ constants/        # Constantes da aplica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ env/              # Valida√ß√£o de vari√°veis de ambiente
‚îÇ   ‚îú‚îÄ‚îÄ helpers/          # Fun√ß√µes auxiliares
‚îÇ   ‚îú‚îÄ‚îÄ hooks/            # Custom React hooks
‚îÇ   ‚îú‚îÄ‚îÄ http/             # APIs geradas pelo Orval
‚îÇ   ‚îú‚îÄ‚îÄ http-courses/     # APIs geradas pelo Orval
‚îÇ   ‚îú‚îÄ‚îÄ lib/              # Bibliotecas e utilit√°rios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jwt-utils.ts      # Utilit√°rios JWT
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ token-refresh.ts  # L√≥gica de refresh token
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ middleware-helpers.ts
‚îÇ   ‚îú‚îÄ‚îÄ middleware.ts     # Middleware do Next.js
‚îÇ   ‚îú‚îÄ‚îÄ mocks/            # Mocks para testes
‚îÇ   ‚îú‚îÄ‚îÄ providers/        # Context providers
‚îÇ   ‚îî‚îÄ‚îÄ types/            # Tipos TypeScript compartilhados
‚îú‚îÄ‚îÄ .env                  # Vari√°veis de ambiente
‚îú‚îÄ‚îÄ .nvmrc                # Vers√£o do Node.js
‚îú‚îÄ‚îÄ biome.json            # Configura√ß√£o do Biome (linter/formatter)
‚îú‚îÄ‚îÄ components.json       # Configura√ß√£o do shadcn/ui
‚îú‚îÄ‚îÄ custom-fetch.ts       # Fetch customizado para Orval
‚îú‚îÄ‚îÄ custom-fetch-course.ts
‚îú‚îÄ‚îÄ Dockerfile            # Docker para produ√ß√£o
‚îú‚îÄ‚îÄ next.config.ts        # Configura√ß√£o do Next.js
‚îú‚îÄ‚îÄ orval.config.ts       # Configura√ß√£o do Orval
‚îú‚îÄ‚îÄ package.json          # Depend√™ncias e scripts
‚îú‚îÄ‚îÄ postcss.config.mjs    # Configura√ß√£o PostCSS
‚îú‚îÄ‚îÄ README.md             # README padr√£o
‚îú‚îÄ‚îÄ tsconfig.json         # Configura√ß√£o TypeScript
‚îî‚îÄ‚îÄ doc.md                # Esta documenta√ß√£o
```

## Scripts Dispon√≠veis

| Script    | Comando         | Descri√ß√£o                                        |
| --------- | --------------- | ------------------------------------------------ |
| **dev**   | `npm run dev`   | Inicia servidor de desenvolvimento com Turbopack |
| **build** | `npm run build` | Cria build de produ√ß√£o                           |
| **start** | `npm start`     | Inicia servidor de produ√ß√£o                      |
| **lint**  | `npm run lint`  | Executa linter                                   |
| **orval** | `npx orval`     | Gera c√≥digo TypeScript da API                    |

## Docker

O projeto inclui um `Dockerfile` para deployment. Para construir a imagem:

```bash
# Build da imagem
docker build -t superapp .

# Rodar container
docker run -p 3000:3000 superapp
```

## Tecnologias Principais

### Frontend

- **Next.js 15**: Framework React com App Router
- **React 19**: Biblioteca UI
- **TypeScript**: Tipagem est√°tica
- **Tailwind CSS**: Estiliza√ß√£o utility-first
- **Radix UI**: Componentes acess√≠veis e sem estilo
- **shadcn/ui**: Biblioteca de componentes

### Autentica√ß√£o e Seguran√ßa

- **Keycloak**: Servidor de autentica√ß√£o OAuth 2.0 / OIDC
- **jwt-decode**: Decodifica√ß√£o de JWT no frontend
- **CSP**: Content Security Policy configurada

### Formul√°rios e Valida√ß√£o

- **React Hook Form**: Gerenciamento de formul√°rios
- **Zod**: Valida√ß√£o de schemas
- **libphonenumber-js**: Valida√ß√£o de telefones

### APIs e HTTP

- **Orval**: Gera√ß√£o de c√≥digo a partir de OpenAPI
- **Fetch API**: Cliente HTTP nativo

### Analytics e Monitoramento

- **Google Analytics**: Tracking de usu√°rios
- **Google Tag Manager**: Gerenciamento de tags
- **Hotjar**: An√°lise de comportamento

### Outras

- **date-fns**: Manipula√ß√£o de datas
- **Swiper**: Carross√©is e sliders
- **canvas-confetti**: Anima√ß√µes de confete
- **react-hot-toast / sonner**: Notifica√ß√µes toast

## Contribuindo

1. Crie uma branch para sua feature: `git checkout -b feat/ck-999999/my-feature`
2. Commit suas mudan√ßas: `git commit -m 'feat(courses-page): add my-courses list'`
3. Push para a branch: `git push origin feat/ck-999999/my-feature`
4. Abra um Pull Request

---

> üìÖ √öltima atualiza√ß√£o: Outubro 2025
